#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset
# set -o xtrace

# This command is run from inside the site directory.
# We can use the directory name as the site name.
NAME=${PWD##*/}

# Get custom configs.
if [ -e ~/.compro ]; then
  source ~/.compro
fi

# Allow flag to override config.
while getopts "t:" OPTION
do
  case $OPTION in
    t)
      LOCAL_EXT=$OPTARG
      ;;
  esac
done

if ! [ ${LOCAL_EXT+_} ]; then
  read -p "Enter dotless TLD for URL, or leave blank for none: " LOCAL_EXT \n
fi

# Create drush alias file.
mkdir sites/all/drush
touch sites/all/drush/$NAME.aliases.drushrc.php
echo "Creating drush alias file..."
echo "<?php" >> sites/all/drush/${NAME}.aliases.drushrc.php
echo "" >> sites/all/drush/${NAME}.aliases.drushrc.php
echo "\$aliases['dev-"${USER}"'] = array(" >> sites/all/drush/$NAME.aliases.drushrc.php

if [ -z ${LOCAL_EXT} ]; then
  echo "  'uri' => '"${NAME}"'," >> sites/all/drush/${NAME}.aliases.drushrc.php
else
  echo "  'uri' => '"${NAME}"."${LOCAL_EXT}"'," >> sites/all/drush/${NAME}.aliases.drushrc.php
fi

echo "  'root' => '"$(pwd)"'," >> sites/all/drush/${NAME}.aliases.drushrc.php
echo ");" >> sites/all/drush/${NAME}.aliases.drushrc.php
