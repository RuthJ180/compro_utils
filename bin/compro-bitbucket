#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset
# set -o xtrace

# Help info.
THIS="compro-bitbucket"
DESC="Create/push a bitbucket repo. Prompts if defaults aren't set in ~/.compro."
USAGE="compro-bitbucket"
declare -A FLAGS
FLAGS=(
  [h]="Get help info"
  [r]="Specify a remote other than origin"
)

# This command is run from inside the site directory.
# We can use the directory name as the site name.
NAME=${PWD##*/}
REMOTE='origin'

# @TODO allow a -r flag for overriding origin to a desired remote name.
# Allow flag to override config.
while getopts "hr:" OPTION
do
  case $OPTION in
    h)
      echo "### ${THIS}

${DESC}

#### Usage

  > ${USAGE}

#### Flags
"
      for i in "${!FLAGS[@]}"
      do
        echo "**$i** ${FLAGS[$i]}"
      done
      echo ""
      exit 0
      ;;
    r)
      REMOTE=${OPTARG}
      ;;
  esac
done

# Get custom configs.
if [ -e ~/.compro ]; then
  source ~/.compro
fi

if ! [ ${BITBUCKET_USER+_} ]; then
  read -p "Enter your bitbucket username: " BITBUCKET_USER \n
fi

if ! [ ${BITBUCKET_PASS+_} ]; then
  read -s -p "Enter your bitbucket password: " BITBUCKET_PASS \n
fi

# Create bitbucket repo.
curl --user ${BITBUCKET_USER}:${BITBUCKET_PASS} https://api.bitbucket.org/1.0/repositories/ --data name=${NAME} --data is_private=true --data owner=alexfisher --data scm=git --data language=php

# Set up remote origin and make first push.
git remote add ${REMOTE} git@bitbucket.org:alexfisher/${NAME}.git
git push -u ${REMOTE} --all